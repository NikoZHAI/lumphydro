{% extends 'hbvapp/layout.html' %}

{% block body %}

	<script type="text/javascript">
		var render_text = function(csvFile, onLoadCallback){
			var reader = new FileReader();
			reader.onload = onLoadCallback;
			reader.readAsText(csvFile);
		}

		$(document).ready(function(){

			/* Initialize svg */
			schema = create_schema();
			/* Each tank is 2-3rd filled when initialized */
			schema.tanks = schema.init_animation();

			d3.select("#id_date_slider")
				.on("input", function(){
		    	var index = parseInt(this.value);
		    	schema.point_to(index);
			  });

			/* File input helper */
			$("#id_browse").on('click', function(){
				$("#id_loadStatus").html("");
				$("#id_summary").fadeOut(600);
				$("#id_csvFileInput").val("");
			  $("#id_csvFileInput").trigger('click');
			});
			/* File input helper END */

			/* Collapse helper */
			$('#id_parList .panel-primary').on('click', function () {
				var thisdiv = ($(this).find(":nth-child(2)"));
				var thiselm = thisdiv[0];
			  $(thiselm).collapse('show');
			});
			/* Collapse helper END */

			/* Reading file jQuery */
			$("#id_csvFileInput").on("change", function(e){
				$("#id_fileNamePlaceHolder").val($(this).val().replace(/C:\\fakepath\\/i, ''));
				render_text(this.files[0], function(e){
					var text = e.target.result;
					window.init_data = initialize_data(text, client_context);
					$.ajax({
						url: "",
						type: "POST",
						async: true,
						data: {'data': JSON.stringify(init_data), 'action': 'load_file'},
						success: function(data){
							if (isEmpty(data.error)) {
								$("#id_loadStatus").html('<span class="text-success"><i class="glyphicon glyphicon-ok"></i></span>');
								$("#id_summary").fadeIn(600);
							}
							else {

							}
						}
					});
				});
			});
			/* Reading file jQuery END */

			/* Summarizing file jQuery */
			$("#id_summary").on("click", function(e){
				$.ajax({
					url: "",
					type: "POST",
					async: true,
					data: {'action': 'summarize'},
					success: function(data){
						$("#id_sizeDFTitle").text('Size of the file:');
						$("#id_sizeDF").text(data.size + " lines");
						$("#id_outDFHeadTitle").text("Test Output");
						$("#id_outDFHead").text(data.res_head);
					}
				});
			});
			/* Summarizing file END */

			/* Calibration jQuery */
			$("#id_calibrate").on("click", function(){
				var action = 'calibrate';
				var config = generate_config_dict();
				var par = generate_par_dict(action);
				var st = generate_st_dict();
				$.ajax({
					url: "",
					type: "POST",
					async: true,
					data: {'config': JSON.stringify(config),
								'par': JSON.stringify(par),
								'st': JSON.stringify(st),
								'action': action},
					success: function(data){
						show_calibrated_par(data.par);
						$("#id_sizeDFTitle").text('Size of the file:');
						$("#id_sizeDF").text(data.size + " lines");
						$("#id_outDFHeadTitle").text("Test Output");
						$("#id_outDFHead").text(data.res_head);
						deploy_plots(data.plots);
						schema.data = data.data;
						schema.bounds = data.extremes;
						init_slider();
					}
				});
			});
			/* Calibration jQuery END */

			/* Simulation jQuery */
			$("#id_simulate").on("click", function(){
				var action = 'simulate';
				var config = generate_config_dict();
				var par = generate_par_dict(action);
				var st = generate_st_dict();
				$.ajax({
					url: "",
					type: "POST",
					async: true,
					data: {'config': JSON.stringify(config),
								'par': JSON.stringify(par),
								'st': JSON.stringify(st),
								'action': action},
					success: function(data){
						$("#id_sizeDFTitle").text('Size of the file:');
						$("#id_sizeDF").text(data.size + " lines");
						$("#id_outDFHeadTitle").text("Test Output");
						$("#id_outDFHead").text(data.res_head);
						deploy_plots(data.plots);
						schema.data = data.data;
						schema.bounds = data.extremes;
						init_slider();
					}
				});
			});
			/* Simulation jQUery END */

			/* Change Context jQuery */
			$("input").not(":input[type=range], :input[type=file], :input[type=date]").on("change", function(e){
				changeContextWhenInput(this);
			});
			/* Change Context jQuery END */

			/**/
			$(function () {
        $('#calibrate_from').datetimepicker({
        	format: "YYYY-MM-DD"
        });
        $('#calibrate_to').datetimepicker({
        	format: "YYYY-MM-DD",
          useCurrent: false //Important! See issue #1075
        });

        /* Date picker event handeler */
        $("#calibrate_from").on("dp.change", function (e) {
        	var begin = e.date.format("YYYY-MM-DD");
        	client_context.calibrate_from = {date: begin, index: ""};
          $('#calibrate_to').data("DateTimePicker").minDate(begin);
        });
        $("#calibrate_to").on("dp.change", function (e) {
        	var end = e.date.format("YYYY-MM-DD");
        	client_context.calibrate_to = {date: end, index: ""};
          $('#calibrate_from').data("DateTimePicker").maxDate(end);
        });
        /* Date picker event handeler END*/
	    });

			$("#id_select_date_range").on("change", function(e){
				if (e.target.checked == true) {
					client_context.id_select_date_range = true;
					$("#datepicker_calibration").toggle(600);
				}
				else {
					client_context.id_select_date_range = false;
					$("#datepicker_calibration").toggle(600);
				}
			});
			/**/
		});

	</script>

	<div name="title" id="id_title">
			<h1>HBV  <small>Hydrology Model</small></h1>
	</div>

	<hr>

	<div class="row" name="main" id="id_main">

		<div class="col-md-4" name="panelLeft" id="id_panelLeft">
			<div class="panel panel-primary">
  			<div class="panel-body">
  				{% include 'hbvapp/includes/_panelLeft.html' %}
  			</div>
  		</div>
		</div>

		<div class="col-md-8" name="panelRight" id="id_panelRight">
			
			<div class="row" name="operations" id="operations">

				<!-- File input group -->
				<div class="form-group col-md-4">
					<input type="file" name="csvFileInput" id="id_csvFileInput" accept="text/csv, .csv"/>
					<div class="input-group col-xs-12">
						<span class="input-group-addon"><i class="glyphicon glyphicon-file"></i></span>
						<input type="text" class="form-control" disabled placeholder="Select .csv file" id="id_fileNamePlaceHolder">
						<span class="input-group-btn">
							<button class="btn input" type="button" id="id_browse"><i class="glyphicon glyphicon-search"></i> Browse</button>
						</span>
					</div>
				</div>
				<!-- File input group END -->
				
				<!-- File load status ! hidden ! -->
				<div class="col-md-2">
					<span name="loadStatus" id="id_loadStatus"></span>
					<button class="btn btn-success" name="summary" id="id_summary">SUMMARY</button>
				</div>
				<!-- File load status END -->

				<!-- Simulate button -->
				<div class="col-md-2 col-md-offset-2 text-right">
					<button class="btn btn-primary btn-sm" name="simulate" id="id_simulate"><strong>SIMULATE</strong></button>
				</div>
				<!-- Simulate button END -->
				
				<!-- Calibrate button -->
				<div class="col-md-1 text-right">
					<button class="btn btn-primary btn-sm" name="calibrate" id="id_calibrate"><strong>CALIBRATE</strong></button>
				</div>
				<!-- Calibrate button END -->
			</div><br>

			<div class="panel panel-info">
  			<div class="panel-body">
  				{% include 'hbvapp/includes/_panelRight.html' %}
  			</div>
  		</div>
			<div class="row">
				<div>
					
				</div>
				<p id="id_sizeDFTitle">Waiting for operation....</p>
				<span id="id_sizeDF"></span>
				<h3 id="id_outDFHeadTitle"></h3>
				<p id="id_outDFHead"></p>
			</div>
		</div>
	
	</div>

{% endblock %}